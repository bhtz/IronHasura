@page "/workflow-definitions"
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@attribute [Authorize]
@inject IAccessTokenProvider TokenProvider
<PageTitle>Workflows definition</PageTitle>

<elsa-studio-root server-url="@Host" monaco-lib-path="_content/Elsa.Designer.Components.Web/monaco-editor/min">
    <elsa-studio-workflow-definitions-list></elsa-studio-workflow-definitions-list>
</elsa-studio-root>

@code {
    [Inject]
    private IJSRuntime JsRuntime { get; set; }

    public string Host { get; set; }

    public string AccessToken { get; set; } = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Host = _navigationManager.BaseUri;

        var accessTokenResult = await TokenProvider.RequestAccessToken();
        if (accessTokenResult.TryGetToken(out var token))
        {
            AccessToken = token.Value;
        }
    }

    protected async override Task OnAfterRenderAsync(bool firstRender)
    {
        if (!string.IsNullOrEmpty(AccessToken))
        {
            await this.JsRuntime.InvokeVoidAsync("interop.registerElsaPlugin", "elsa-studio-root", AccessToken);
        }
    }
}
